@page "/BookingInfo"
@page "/BookingInfo/{Id:int}"
@using PacificTours.Shared.Entities
@using PacificTours.Shared
@inject HttpClient Http
@inject NavigationManager NavigationManager

<h3>Booking Info</h3>

@if (_hotelInfo is null && _tourInfo is null)
{
    <br/>
    <span>Loading Booking Info...</span>
    <br/>
}
else
{
    <br/>
    <h4>Booking Status: @_booking.Status</h4>
    <br/>
    @if (_hotelInfo is not null && _tourInfo is not null)
    {
        <br/>
        <div style="display:block; width:100%;">
            <div style="width:50%; float: left; display: inline-block;">
                <h5>Hotel Booking</h5>
                <div>Name: @_hotelInfo.Name</div>
                <div>Room Type: @_hotelInfo.RoomType</div>
                <div>Start Date: @_startDate</div>
                <div>End Date: @_endDate</div>
                <div>Cost per night: £@_hotelInfo.RoomCost</div>
                @if (_booking.Status == "In Progress")
                {
                    <button class="btn btn-danger" @onclick="() => RemoveBooking(_hotel, _hotelInfo.Id)">Cancel</button>
                }
            </div>
            <div style="width:50%; float: left; display: inline-block;">
                <h5>Tour Booking</h5>
                <div>Name: @_tourInfo.Name</div>
                <div>Duration: @_tourInfo.Duration days</div>
                <div>Cost: £@_tourInfo.Cost</div>
                @if (_booking.Status == "In Progress")
                {
                    <button class="btn btn-danger" @onclick="() => RemoveBooking(_hotel, _hotelInfo.Id)">Cancel</button>
                }
            </div>
        </div>
    }
    else if (_hotelInfo is not null)
    {
        <br/>
        <div style="display:block; width:100%;">
            <div style="width:50%; float: left; display: inline-block;">
                <h5>Hotel Booking</h5>
                <div>Name: @_hotelInfo.Name</div>
                <div>Room Type: @_hotelInfo.RoomType</div>
                <div>Start Date: @_startDate</div>
                <div>End Date: @_endDate</div>
                <div>Cost per night: £@_hotelInfo.RoomCost</div>
                @if (_booking.Status == "In Progress")
                {
                    <button class="btn btn-danger" @onclick="() => RemoveBooking(_hotel, _hotelInfo.Id)">Cancel</button>
                }
            </div>
            <div style="width:50%; float: left; display: inline-block;">
                @if (_booking.Status == "In Progress")
                {
                    <div>No Tour booking. If you add a Tour and create a package, you'll receive a discount.</div>
                }
            </div>
        </div>
    }
    else if (_tourInfo is not null)
    {
        <br/>
        <div style="display:block; width:100%;">
            <div style="width:50%; float: left; display: inline-block;">
                <h5>Tour Booking</h5>
                <div>Name: @_tourInfo.Name</div>
                <div>Duration: @_tourInfo.Duration days</div>
                <div>Cost: £@_tourInfo.Cost</div>
                @if (_booking.Status == "In Progress")
                {
                    <button class="btn btn-danger" @onclick="() => RemoveBooking(_hotel, _hotelInfo.Id)">Cancel</button>
                }
            </div>
            <div style="width:50%; float: left; display: inline-block;">
                @if (_booking.Status == "In Progress")
                {
                    <div>No Hotel booking. If you add a Hotel and create a package, you'll receive a discount.</div>
                }
            </div>
        </div>
    } 
    <br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>
    @if (_booking.Status == "In Progress")
    {
        <div>Total Cost: £@_booking.TotalCost</div>
        <br/>
        <button class="btn btn-primary" @onclick="ReserveBooking">Reserve Booking</button>
    }
    else if (_booking.Status == "Reserved")
    {
        <div>Remaining amount must be paid 28 days before booking start date</div>
        <br/>
        <div>Left to pay: £@_booking.TotalCost</div>
        <button class="btn btn-primary" >Confirm Booking</button>
    }
}


@code {
    [Parameter]
    public int? Id { get; set; }

    TourBookingInfoDto? _tourInfo;
    HotelBookingInfoDto? _hotelInfo;
    private Booking? _booking;
    private readonly string _hotel = "hotel";
    private readonly string _tour = "tour";
    private DateOnly _startDate;
    private DateOnly _endDate;

    protected override async Task OnInitializedAsync()
    {
        var authorized = await Http.GetFromJsonAsync<bool>($"api/Auth/IsAuthorized?id={Id}");
        if (!authorized)
        {
            NavigationManager.NavigateTo("/");
        }
        
        var tourResult = await Http.GetFromJsonAsync<TourBookingInfoDto>($"api/Booking/TourBookingInfo?id={Id}");
        var hotelResult = await Http.GetFromJsonAsync<HotelBookingInfoDto>($"api/Booking/HotelBookingInfo?id={Id}");
        var bookingResult = await Http.GetFromJsonAsync<Booking>($"api/Booking/GetBookingInfo?id={Id}");
        _booking = bookingResult;

        if (tourResult is null && hotelResult is null)
        {
            NavigationManager.NavigateTo("/");
        }
        if (tourResult != null)
        {
            _tourInfo = tourResult;
        }
        if (hotelResult != null)
        {
            _hotelInfo = hotelResult;
            _startDate = DateOnly.FromDateTime(_hotelInfo.StartDate);
            _endDate = DateOnly.FromDateTime(_hotelInfo.EndDate);
        }
    }
    
    
    private async Task ReserveBooking()
    {
        NavigationManager.NavigateTo("/Payment");

    }
    
    private async Task RemoveBooking(string type, int id)
    {
        if (type == _hotel)
        {
            await Http.DeleteAsync($"api/Booking/DeleteHotel?id={id}");
            NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
        }
        else
        {
            await Http.DeleteAsync($"api/Booking/DeleteTour?id={id}" );
            NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
        }

    }
}