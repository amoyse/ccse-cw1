@page "/BookingInfo"
@using PacificTours.Shared.Entities
@using PacificTours.Shared
@inject HttpClient Http
@inject NavigationManager NavigationManager

<h3>Booking Info</h3>

@if (_hotelInfo is null && _tourInfo is null)
{
    <br/>
    <span>Loading Booking Info...</span>
    <br/>
}
else
{
    @if (_hotelInfo is not null && _tourInfo is not null)
    {
        <br/>
        <div style="display:block; width:100%;">
            <div style="width:50%; float: left; display: inline-block;">
                <h5>Hotel Booking</h5>
                <div>Name: @_hotelInfo.Name</div>
                <div>Room Type: @_hotelInfo.RoomType</div>
                <div>Cost: £@_hotelInfo.RoomCost</div>
                <button class="btn btn-danger" @onclick="() => RemoveBooking(_hotel, _hotelInfo.Id)">Cancel</button>
            </div>
            <div style="width:50%; float: left; display: inline-block;">
                <h5>Tour Booking</h5>
                <div>Name: @_tourInfo.Name</div>
                <div>Duration: @_tourInfo.Duration days</div>
                <div>Cost: £@_tourInfo.Cost</div>
                <button class="btn btn-danger" @onclick="() => RemoveBooking(_tour, _tourInfo.Id)">Cancel</button>
            </div>
        </div>
    }
    else if (_hotelInfo is not null)
    {
        <br/>
        <div style="display:block; width:100%;">
            <div style="width:50%; float: left; display: inline-block;">
                <h5>Hotel Booking</h5>
                <div>Name: @_hotelInfo.Name</div>
                <div>Room Type: @_hotelInfo.RoomType</div>
                <div>Cost: £@_hotelInfo.RoomCost</div>
                <button class="btn btn-danger" @onclick="() => RemoveBooking(_hotel, _hotelInfo.Id)">Cancel</button>
            </div>
            <div style="width:50%; float: left; display: inline-block;">
                <div>No Tour booking. If you add a Tour and create a package, you'll receive a discount.</div>
            </div>
        </div>
    }
    else if (_tourInfo is not null)
    {
        <br/>
        <div style="display:block; width:100%;">
            <div style="width:50%; float: left; display: inline-block;">
                <h5>Tour Booking</h5>
                <div>Name: @_tourInfo.Name</div>
                <div>Duration: @_tourInfo.Duration days</div>
                <div>Cost: £@_tourInfo.Cost</div>
                <button class="btn btn-danger" @onclick="() => RemoveBooking(_tour, _tourInfo.Id)">Cancel</button>
            </div>
            <div style="width:50%; float: left; display: inline-block;">
                <div>No Hotel booking. If you add a Hotel and create a package, you'll receive a discount.</div>
            </div>
        </div>
    } 
    <br/><br/><br/><br/><br/><br/><br/>
    <div>Total Cost: £@_totalCost</div>
    <br/>
    <button class="btn btn-primary" @onclick="ReserveBooking">Reserve Booking</button>
}


@code {

    TourBookingInfoDto? _tourInfo;
    HotelBookingInfoDto? _hotelInfo;
    private int _totalCost = 0;
    private string _hotel = "hotel";
    private string _tour = "tour";

    protected override async Task OnInitializedAsync()
    {
        var tourResult = await Http.GetFromJsonAsync<TourBookingInfoDto>("api/Booking/TourBookingInfo");
        var hotelResult = await Http.GetFromJsonAsync<HotelBookingInfoDto>("api/Booking/HotelBookingInfo");

        if (tourResult is null && hotelResult is null)
        {
            NavigationManager.NavigateTo("/");
        }

        if (tourResult != null)
        {
            _tourInfo = tourResult;
            _totalCost += _tourInfo.Cost ?? default(int);
        }
        if (hotelResult != null)
        {
            _hotelInfo = hotelResult;
            _totalCost += _hotelInfo.RoomCost;
        }
        if (_tourInfo is not null && _hotelInfo is not null)
        {
            CalcDiscount(_hotelInfo.RoomType);
        }
        
    }

    private void CalcDiscount(string roomType)
    {
        if (roomType == "Single")
        {
            _totalCost = (int)(_totalCost * 0.9);
        } 
        else if (roomType == "Double")
        {
            _totalCost = (int)(_totalCost * 0.8);
        }
        else if (roomType == "Family")
        {
            _totalCost = (int)(_totalCost * 0.6);
        }
    }
    
    
    private async Task ReserveBooking()
    {
        NavigationManager.NavigateTo("/Payment");

    }
    
    private async Task RemoveBooking(string type, int id)
    {
        if (type == _hotel)
        {
            await Http.DeleteAsync($"api/Booking/DeleteHotel?id={id}");
            NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
        }
        else
        {
            await Http.DeleteAsync($"api/Booking/DeleteTour?id={id}" );
            NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
        }

    }
}
    